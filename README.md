# Simple OAuth Magic Link

This module provides the ability to use so called "Magic Links" to log a user in without the need for a password.
The main motivation behind this module is for decoupled installations to use one time login urls via OAuth2.

**Features:**

- Provide password-less login
- Use the "Magic Link" instead of the traditional password reset url
- Magic Links are configurable per Consumer (see consumer module)
- Custom tokens to use a Magic Link in user account emails
- Magic links support additional query parameters, useful to pass e.g. a password reset hash.
- Extend magic link tokens via hooks.


## Updating E-Mail Templates

By default, the account emails use the `[user:one-time-login-url]` token to generate a one time login url.

This token needs to be replaced by one of the following:

- `[user:magic-link-login]`
- `[user:magic-link-password-reset]`

The password-reset token creates a password reset hash and timestamp and adds it as a query parameter
to the magic link.
The login token just creates a magic link.

Magic link generation is depending on the negotiated consumer of the request.
Make sure to configure your consumer(s) accordingly!

*It is up to the client implementation to handle the login and additional steps like resetting the password.*


## Using magic links

A magic link is generated by using the base url and path template from the magic link settings.

Additional data may be passed in the magic link via query parameters!

The magic link `code` is just an *Authorization Code* from the `simple_oauth` module.
This enables the client to use the second step of the *Authorization Code Grant* flow to obtain an access token:

`POST` request to `/oauth/token` with the following payload:

|Key|Value|
|-|-|
|grant_type|authorization_code|
|client_id|the-client-id|
|client_secret|the-client-secret|
|code|the-code-from-the-magic-link|

**Make sure to enable the Authorization Code Grant in your client consumer!**


## Testing & Linting

Tests and Linting can easily be ran via DDEV and the awesome drupal-spoons composer plugin:

*This creates an isolated drupal installation solely for testing.*

- Make sure DDEV is installed.
- Navigate to the module folder.
- Run `ddev start`.

Lint via `ddev phpcs` or `ddev phpcbf`.
Run tests via `ddev phpunit`.

**Change environments**
By running `ddev change-env` the environment (PHP and Drupal version) can be changed.

